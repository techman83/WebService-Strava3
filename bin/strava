#!/usr/bin/perl
use v5.10.0;
use strict;
use warnings;
use WebService::Strava;
use Getopt::Long;
use File::Spec;
use Data::Dumper;

# PODNAME: strava

# ABSTRACT: strava - Command line interface to Strava

# VERSION

=head1 SYNOPSIS

Usage:

    strava setup                            : Configure Oauth2 authentication

    Debugging commands:
    
    strava version                          : Show version information

=head1 SETUP

=head2 Installation

If you have not already installed this software, the easiest way
is to use L<cpanm> and L<local::lib>. If you don't have them installed,
it's easy with:

    curl -L http://cpanmin.us/ | perl - --self-upgrade
    ~/perl5/bin/cpanm -L ~/perl5 App::local::lib::helper
    source ~/perl5/bin/localenv-bashrc

You might want to put that last line in your F<~/.bashrc> file.

You can then install C<strava> and related utilities with:

    cpanm WebService::Strava3

=head2 API Registration

You will need to register for a Client Secret + Access token here:
https://www.strava.com/settings/api

Set the authorization callback domain to: http://127.0.0.1

=head2 Configuration

You will need the following

  client_id     = xxxxx
  client_secret = xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

You can get these values by going to https://www.strava.com/settings/api
and registering your application. After registration simply run:

    strava setup

=head1 DESCRIPTION

This is a command-line client for the L<Strava|http://strava.com/>
service.  Use C<strava> with no arguments for help.

This interface needs expanding! Submit issues with feature requests and
I will look at adding them, I currently don't have any use cases for
it.

=head1 BUGS/Features Requests

Please submit any bugs, feature requests to
L<https://github.com/techamn83/WebService-Strava3/issues> .

Contributions are more than welcome!

=head1 SEE ALSO

L<WebService::Strava3>

=cut

# $progname is just a nicer-formatted version of $0 (our command name)
my $PROGNAME = (File::Spec->splitpath($0))[2];
$PROGNAME ||= 'strava';

my $strava = WebService::Strava->new();

if (! @ARGV) {
  &print_usage;
}

my $getopts_rc = GetOptions(
  "setup"       => \&setup,
  "version"     => \&version,

  "help|?"        => \&print_usage,
);

sub print_usage {
  say q{
  Usage:

  strava setup                          : Configure Oauth2 authentication

  Debugging commands:
  
  strava version                        : Show version information

  For more documentation, use `perldoc strava`.
  };

  exit 1;
}


sub version {
  $::VERSION ||= "Unreleased";
  say "strava version                 : $::VERSION";
  say "WebService::Strava version     : ", $strava->VERSION;
}

sub setup {
  $strava->auth->setup;
  my $athlete = $strava->athlete();

  if ($athlete->{firstname}) {
    say "Congratulations $athlete->{firstname}, you appear to have authenticated successfully!";
  }
}


